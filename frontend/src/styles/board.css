/* src/styles/board.css
 * ===========================
 * Board 页面全局样式：
 * - 页面 & 画布 & 网格 & 连线
 * - 设备节点 & 缩放手柄
 * - 浮动卡片通用风格（Input / Status）
 * - 浮动卡片中的 Element Plus 表单皮肤
 * =========================== */

/* ========== 页面 & 画布 ========== */

.iot-board {
    position: relative;
    width: 100vw;
    height: 100vh;
    box-sizing: border-box;
    overflow: hidden;
    background:
            radial-gradient(circle at top, var(--iot-color-bg-body) 0%, var(--iot-color-bg-body) 40%, var(--iot-color-bg-body) 100%);
    color: var(--iot-color-text);
    font-size: var(--iot-font-base);
}

/* 背景画布：负责撑满和裁剪，不再承担网格绘制 */
.iot-board .canvas {
    position: absolute;
    inset: 0;
    overflow: hidden; /* 避免浏览器自带滚动条 */
    background-color: var(--iot-color-bg-canvas);
}

/* 画布内部：真正被平移 / 缩放的层，负责网格 + 节点 */
.iot-board .canvas-inner {
    position: relative;
    width: calc(100vw * 4); /* 扩大到4倍屏幕宽度，确保完全覆盖 */
    height: calc(100vh * 4); /* 扩大到4倍屏幕高度，确保完全覆盖 */
    min-width: 400vw;
    min-height: 400vh;

    /* 网格背景：跟随 translate / scale 一起变化 */
    background-image:
            linear-gradient(90deg, var(--iot-color-grid) 1px, transparent 0),
            linear-gradient(180deg, var(--iot-color-grid) 1px, transparent 0);
    background-size: var(--iot-grid-size) var(--iot-grid-size);
}

/* 连线层（SVG） */
.iot-board .edge-layer {
    position: absolute;
    inset: 0;
    width: 100%;
    height: 100%;
    pointer-events: none;
    overflow: visible;
}

/* 连线（包含自环 path 和普通 line） */
.iot-board .edge-layer .edge-line {
    fill: none; /* 自环 path 不要填充，否则会出现"黑洞" */
    stroke-width: 2;
    stroke-linecap: round;
    stroke-dasharray: 4, 8; /* 虚线样式：8px实线，4px空白 */
}

/* 可选：如果你的箭头 marker 需要单独类名 */
.iot-board .edge-layer .edge-arrow {
    fill: var(--iot-color-edge);
}

/* ========== 节点 ========== */

.iot-board .device-node {
    position: absolute;
    /* Allow Tailwind background classes to work */
    background: transparent;
    border-radius: var(--iot-radius-node);
    display: flex;
    flex-direction: column;
    align-items: stretch;
    justify-content: center;
    cursor: grab;
    box-shadow: var(--iot-node-shadow);
    border: 1px solid;
    color: var(--iot-color-text);
    user-select: none;
    padding: 4px;
    box-sizing: border-box;
}

.iot-board .device-node:active {
    cursor: grabbing;
}

/* 变量节点（内部变量）- 圆形设计 */
.iot-board .device-node.variable-node {
    border-radius: 50% !important;
    border-width: 2px !important;
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15), inset 0 1px 3px rgba(255, 255, 255, 0.5) !important;
}

.iot-board .device-node.variable-node .device-node-content {
    flex-direction: column;
    justify-content: center;
    align-items: center;
    padding: 0;
}

.iot-board .device-node.variable-node .device-img {
    width: 32px !important;
    height: 32px !important;
    filter: drop-shadow(0 2px 4px rgba(59, 130, 246, 0.3));
}

.iot-board .device-node.variable-node .device-label-wrapper {
    display: none;  /* 隐藏变量节点的文字标签，只显示图标 */
}

/* 变量节点内容容器 */
.iot-board .variable-node-content {
    display: flex;
    justify-content: center;
    align-items: center;
    width: 100%;
    height: 100%;
}

/* 变量节点图标 */
.iot-board .variable-node-content .variable-img {
    width: 36px;
    height: 36px;
    object-fit: contain;
    filter: drop-shadow(0 2px 4px rgba(59, 130, 246, 0.3));
}

/* 变量节点悬停提示 */
.iot-board .device-node.variable-node {
    cursor: pointer;
}

/* 反例路径激活时的设备节点 */
.iot-board .device-node.trace-active {
    animation: tracePulse 1.5s ease-in-out infinite;
}

/* 被攻击的设备节点 - 红色圆圈标记 */
.iot-board .device-node.device-attacked {
    animation: none;
    border-width: 0 !important;
}

/* 被攻击设备的红色圆圈 - 使用伪元素 */
.iot-board .device-node.device-attacked::before {
    content: '';
    position: absolute;
    top: -6px;
    left: -6px;
    right: -6px;
    bottom: -6px;
    border: 3px solid #EF4444;
    border-radius: 50%;
    animation: attackedCirclePulse 1s ease-in-out infinite;
    pointer-events: none;
    z-index: 10;
}

@keyframes tracePulse {
    0%, 100% {
        box-shadow: var(--iot-node-shadow), 0 0 0 0 var(--trace-glow-color, rgba(239, 68, 68, 0.4));
    }
    50% {
        box-shadow: var(--iot-node-shadow), 0 0 0 3px var(--trace-glow-color, rgba(239, 68, 68, 0));
    }
}

@keyframes attackedCirclePulse {
    0%, 100% {
        box-shadow: 0 0 0 0 rgba(239, 68, 68, 0.7), 0 0 10px rgba(239, 68, 68, 0.5);
    }
    50% {
        box-shadow: 0 0 0 4px rgba(239, 68, 68, 0), 0 0 20px rgba(239, 68, 68, 0.8);
    }
}

@keyframes attackedPulse {
    0%, 100% {
        box-shadow: var(--iot-node-shadow), 0 0 0 0 rgba(239, 68, 68, 0.7), 0 0 15px rgba(239, 68, 68, 0.5);
    }
    50% {
        box-shadow: var(--iot-node-shadow), 0 0 0 4px rgba(239, 68, 68, 0), 0 0 25px rgba(239, 68, 68, 0.8);
    }
}

/* 变量节点包装器 - 用于定位提示框 */
.iot-board .variable-node-wrapper {
    position: relative;
    width: 100%;
    height: 100%;
    display: flex;
    justify-content: center;
    align-items: center;
}

/* 自定义悬浮提示框 */
.iot-board .variable-tooltip {
    position: absolute;
    bottom: calc(100% + 12px);
    left: 50%;
    transform: translateX(-50%) scale(0.9);
    background: linear-gradient(135deg, #ffffff 0%, #f8fafc 100%);
    border-radius: 10px;
    padding: 8px 12px;
    display: flex;
    align-items: center;
    gap: 8px;
    opacity: 0;
    visibility: hidden;
    transition: all 0.2s ease;
    z-index: 1000;
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15), 0 0 0 1px rgba(0, 0, 0, 0.05);
    white-space: nowrap;
    pointer-events: none;
}

/* 提示框小箭头 */
.iot-board .variable-tooltip::after {
    content: '';
    position: absolute;
    bottom: -6px;
    left: 50%;
    transform: translateX(-50%) rotate(45deg);
    width: 12px;
    height: 12px;
    background: #f8fafc;
    border-right: 1px solid rgba(0, 0, 0, 0.05);
    border-bottom: 1px solid rgba(0, 0, 0, 0.05);
}

/* 悬停时显示提示框 */
.iot-board .device-node.variable-node:hover .variable-tooltip {
    opacity: 1;
    visibility: visible;
    transform: translateX(-50%) scale(1);
    bottom: calc(100% + 14px);
    animation: tooltipFadeIn 0.2s ease-out;
}

/* 反例路径时提示框一直显示 */
.iot-board .device-node.variable-node .variable-tooltip.variable-tooltip-active {
    opacity: 1;
    visibility: visible;
    transform: translateX(-50%) scale(1);
    bottom: calc(100% + 14px);
}

/* 变量值变化时添加动画效果 */
.iot-board .variable-img.variable-changed {
    animation: variablePulse 1s ease-in-out;
}

@keyframes variablePulse {
    0%, 100% {
        transform: scale(1);
    }
    50% {
        transform: scale(1.15);
        filter: brightness(1.2);
    }
}

@keyframes tooltipFadeIn {
    from {
        opacity: 0;
        transform: translateX(-50%) scale(0.9) translateY(5px);
    }
    to {
        opacity: 1;
        transform: translateX(-50%) scale(1) translateY(0);
    }
}

/* 提示框图标 */
.iot-board .variable-tooltip-icon {
    width: 24px;
    height: 24px;
    border-radius: 6px;
    background: linear-gradient(135deg, #eff6ff 0%, #dbeafe 100%);
    display: flex;
    justify-content: center;
    align-items: center;
    padding: 3px;
}

.iot-board .variable-tooltip-icon img {
    width: 18px;
    height: 18px;
    object-fit: contain;
}

/* 提示框信息 */
.iot-board .variable-tooltip-info {
    display: flex;
    flex-direction: column;
    gap: 1px;
}

.iot-board .variable-tooltip-label {
    font-size: 12px;
    font-weight: 600;
    color: #1e293b;
    letter-spacing: 0.3px;
}

/* 提示框变量值 */
.iot-board .variable-tooltip-value {
    font-size: 10px;
    color: #3b82f6;
    font-weight: 500;
}

/* 设备节点主体容器：包含上部分和状态 */
.iot-board .device-node-content {
    display: flex;
    flex-direction: column;
    align-items: stretch;
    justify-content: space-between;
    width: 100%;
    height: 100%;
    gap: 4px;
    padding: 4px;
    box-sizing: border-box;
}

/* 上部分：左边图标，右边名字 */
.iot-board .device-top-row {
    display: flex;
    align-items: center;
    justify-content: flex-start;
    gap: 8px;
    width: 100%;
    flex: 1;
    min-height: 0;
}

/* 节点名字容器：带背景和圆角 */
.iot-board .device-label-wrapper {
    flex: 1;
    min-width: 0;
    display: flex;
    align-items: center;
}

/* 节点图标图片：不响应鼠标事件，避免拖拽图片 */
.iot-board .device-img {
    pointer-events: none;
    flex-shrink: 0;
    object-fit: contain;
    filter: drop-shadow(0 2px 3px rgba(0, 0, 0, 0.15));
}

/* 节点文字：基础排版，具体字号由 JS 控制 */
.iot-board .device-label {
    font-weight: 600;
    text-align: left;
    padding: 3px 6px;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
    color: #1e293b;
    font-size: 11px;
    background: linear-gradient(135deg, rgba(255, 255, 255, 0.9) 0%, rgba(248, 250, 252, 0.85) 100%);
    border-radius: 5px;
    box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1), inset 0 1px 0 rgba(255, 255, 255, 0.8);
    border: 1px solid rgba(226, 232, 240, 0.8);
    line-height: 1.3;
}

/* ========== 节点缩放手柄 ========== */
/* 四角的缩放点：默认透明，hover 节点时出现 */

.iot-board .resize-handle {
    position: absolute;
    width: var(--iot-resize-size);
    height: var(--iot-resize-size);
    border-radius: var(--iot-radius-resize);
    border: 1px solid var(--iot-color-resize-border);
    background: var(--iot-color-resize-bg);
    box-shadow: 0 0 0 1px var(--iot-color-resize-shadow);
    opacity: 0;
    transition: opacity 0.12s;
}

.iot-board .device-node:hover .resize-handle {
    opacity: 1;
}

/* 四个方向的手柄位置 + 光标形状 */
.iot-board .resize-handle.tl {
    left: var(--iot-resize-offset);
    top: var(--iot-resize-offset);
    cursor: nw-resize;
}

.iot-board .resize-handle.tr {
    right: var(--iot-resize-offset);
    top: var(--iot-resize-offset);
    cursor: ne-resize;
}

.iot-board .resize-handle.bl {
    left: var(--iot-resize-offset);
    bottom: var(--iot-resize-offset);
    cursor: sw-resize;
}

.iot-board .resize-handle.br {
    right: var(--iot-resize-offset);
    bottom: var(--iot-resize-offset);
    cursor: se-resize;
}

/* ========== 浮动卡片通用样式 ========== */

.iot-board .floating-card {
    position: absolute;
    background: linear-gradient(
            145deg,
            var(--iot-color-card-bg),
            var(--iot-color-card-bg-strong)
    );
    border-radius: var(--iot-radius-card);
    box-shadow:
            var(--iot-color-card-shadow),
            0 0 0 1px var(--iot-color-card-border);
    backdrop-filter: blur(18px);
    color: var(--iot-color-text);
    display: flex;
    flex-direction: column;
    overflow: hidden;
    font-size: var(--iot-font-base);
    max-height: calc(100vh - 6rem); /* 上下各留 2rem 空隙 */

    transition: var(--iot-transition-dock);
    z-index: 100; /* Standard floating z-index */
    will-change: transform, left, top, width, height;
}


/* 卡片头部：标题栏，可拖动 */
.iot-board .card-header {
    padding: var(--iot-space-sm) var(--iot-space-md);
    display: flex;
    align-items: center;
    gap: var(--iot-space-sm);
    border-bottom: 1px solid var(--iot-color-card-border);
    cursor: move;
    background: radial-gradient(
            circle at top left,
            var(--iot-color-card-header-glow),
            transparent 60%
    );
}

/* 大标题：Input / Status 等 */
.iot-board .card-title {
    font-weight: 600;
    font-size: var(--iot-font-title);
    flex: 1;
    color: var(--iot-color-title);
}

/* 子标题：折叠项标题（Devices / Rules / Specs） */
.iot-board .card-subtitle {
    font-size: var(--iot-font-subtitle);
    font-weight: 500;
    color: var(--iot-color-subtitle);
}

/* 标题右侧按钮（视图切换等） */
.iot-board .card-header-actions {
    display: flex;
    align-items: center;
    gap: var(--iot-space-2xs);
}

/* 卡片主体内容区域：内部滚动 */
.iot-board .card-body {
    padding: var(--iot-space-md) var(--iot-space-md) var(--iot-space-lg);
    flex: 1 1 auto;
    min-height: 0;
    overflow-y: auto;
}

/* 折叠面板统一风格：背景透明，由卡片底色负责 */
.iot-board .panel-collapse {
    --el-collapse-header-bg-color: transparent;
    --el-collapse-content-bg-color: transparent;
    font-size: var(--iot-font-base);
}

/* 折叠标题行：标题 + 右侧图标按钮 */
.iot-board .collapse-title-row {
    display: flex;
    align-items: center;
    justify-content: space-between;
    flex: 1;
    min-width: 0;
}


/* 分割线颜色弱一点，避免喧宾夺主 */
.iot-board .input-card .el-divider {
    border-color: var(--iot-color-divider);
}

/* ========== Element Plus 深色皮肤：输入 / 选择 / 表单 ========== */
/* 对所有浮动卡片生效（InputCard + StatusCard），保证风格统一 */

.iot-board .floating-card .el-input__wrapper,
.iot-board .floating-card .el-select__wrapper {
    background-color: var(--iot-color-input-bg);
    box-shadow: 0 0 0 1px var(--iot-color-input-border);
    border-radius: var(--iot-radius-input);
}

.iot-board .floating-card .el-textarea__inner {
    background-color: var(--iot-color-input-bg);
    border: 1px solid var(--iot-color-input-border-strong);
    border-radius: var(--iot-radius-input);
    color: var(--iot-color-text);
    font-size: var(--iot-font-base);
}

/* 真实输入值 / 已选择的选项：用正常文字颜色 */
.iot-board .floating-card .el-input__inner,
.iot-board .floating-card .el-select__selected-item {
    color: var(--iot-color-text);
    font-size: var(--iot-font-base);
}

/* 占位符：改成偏灰，提示“这是提示词，尚未输入” */
.iot-board .floating-card .el-input__inner::placeholder,
.iot-board .floating-card .el-select__placeholder {
    color: var(--iot-color-text-muted);
    font-size: var(--iot-font-base);
}

.iot-board .floating-card .el-form-item__label {
    color: var(--iot-color-text-muted);
    font-size: var(--iot-font-base);
}

/* 表单项之间默认间距 */
.iot-board .floating-card .el-form-item {
    margin-bottom: 0.875rem;
}

/* --- Docked State --- */

.iot-board .floating-card.is-docked {
    width: var(--iot-dock-icon-size) !important;
    height: var(--iot-dock-icon-size) !important;
    min-height: 0 !important;
    padding: 0;
    border-radius: 50%; /* Make it circular or rounded square */
    background: var(--iot-color-node-bg); /* Use solid bg when docked */
    cursor: pointer;
    z-index: 2000; /* Bring above everything else */
    justify-content: center;
    align-items: center;
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
}

.iot-board .floating-card.is-docked:hover {
    transform: scale(1.1); /* Pop effect */
    border-color: var(--iot-color-edge);
}

/* Docking Orientation Adjustments (Optional specific borders) */
.iot-board .floating-card.dock-left { border-top-left-radius: 0; border-bottom-left-radius: 0; }
.iot-board .floating-card.dock-right { border-top-right-radius: 0; border-bottom-right-radius: 0; }
.iot-board .floating-card.dock-top { border-top-left-radius: 0; border-top-right-radius: 0; }
.iot-board .floating-card.dock-bottom { border-bottom-left-radius: 0; border-bottom-right-radius: 0; }

/* --- Header & Buttons --- */

.iot-board .card-header {
    /* [Modified] Ensure header layout handles the close button */
    padding: var(--iot-space-sm) var(--iot-space-md);
    display: flex;
    align-items: center;
    justify-content: space-between; /* Push 'X' to right */
    gap: var(--iot-space-sm);
    border-bottom: 1px solid var(--iot-color-card-border);
    cursor: pointer;
    background: radial-gradient(
            circle at top left,
            var(--iot-color-card-header-glow),
            transparent 60%
    );
    min-height: 2.5rem;
}

/* Hide normal header content when docked */
.iot-board .floating-card.is-docked .card-header,
.iot-board .floating-card.is-docked .card-body {
    display: none;
}

/* The Icon visible ONLY when docked */
.iot-board .docked-icon-container {
    display: none; /* Hidden by default */
    width: 100%;
    height: 100%;
    align-items: center;
    justify-content: center;
    color: var(--iot-color-edge);
}

.iot-board .floating-card.is-docked .docked-icon-container {
    display: flex; /* Show when docked */
}

/* Close / Dock Button (The 'X') */
.iot-board .dock-close-btn {
    cursor: pointer;
    opacity: 0.6;
    display: flex;
    align-items: center;
    justify-content: center;
    border-radius: 50%;
    width: 1.5rem;
    height: 1.5rem;
    transition: all 0.2s;
}

.iot-board .dock-close-btn:hover {
    opacity: 1;
    background-color: rgba(255, 75, 75, 0.2);
    color: #ff4d4f;
}


/* 核心修复：当处于拖拽状态时，立即移除所有过渡！
 * 这让卡片能 1:1 紧跟鼠标，没有任何延迟
 */
.iot-board .floating-card.is-dragging {
    transition: none !important;
    user-select: none; /* 防止拖拽时选中文字 */
    cursor: grabbing;
}

/* ========== New Layout Styles ========== */

/* Canvas container with sidebars */


/* Grid background pattern */
.grid-bg {
    background-size: 40px 40px;
    background-image: linear-gradient(to right, rgba(148, 163, 184, 0.15) 1px, transparent 1px),
                      linear-gradient(to bottom, rgba(148, 163, 184, 0.15) 1px, transparent 1px);
}

/* Particle line animation */
.particle-line {
    stroke-dasharray: 4, 8;
    animation: dash-animation 30s linear infinite;
}

@keyframes dash-animation {
    from { stroke-dashoffset: 1000; }
    to { stroke-dashoffset: 0; }
}

/* Node container hover effects */
.node-container {
    transition: transform 0.2s cubic-bezier(0.4, 0, 0.2, 1);
}

.node-container:hover {
    transform: scale(1.02);
    z-index: 50;
}

/* Glass node effect */
.glass-node {
    backdrop-filter: blur(12px);
    background: rgba(255, 255, 255, 0.7);
    border: 1px solid rgba(226, 232, 240, 0.8);
    box-shadow: 0 8px 30px rgba(0, 0, 0, 0.06);
}

/* Glow icon effect */
.glow-icon {
    filter: drop-shadow(0 0 2px rgba(0, 0, 0, 0.1));
}

/* Data badge */
.data-badge {
    position: absolute;
    right: -12px;
    top: 0;
    padding: 2px 8px;
    border-radius: 4px;
    font-size: 10px;
    font-weight: bold;
    letter-spacing: 0.025em;
    background: white;
    border: 1px solid rgba(226, 232, 240, 0.8);
    box-shadow: 0 0 8px rgba(0, 0, 0, 0.05);
    z-index: 10;
    color: #475569;
}

/* Pulse status animation */
.pulse-status {
    animation: pulse-border 2s cubic-bezier(0.4, 0, 0.6, 1) infinite;
}

@keyframes pulse-border {
    0%, 100% { box-shadow: 0 0 0 0px rgba(34, 197, 94, 0.7); }
    50% { box-shadow: 0 0 0 6px rgba(34, 197, 94, 0); }
}

/* Slow spin animation for sensors */
.animate-spin-slow {
    animation: spin 3s linear infinite;
}

/* Color utilities */
.text-primary { color: #2563EB; }
.text-secondary { color: #C026D3; }
.bg-online { background-color: #059669; }
.bg-offline { background-color: #dc2626; }
.bg-green-200 { background-color: #bbf7d0; }
.border-blue-100 { border-color: #dbeafe; }
.border-green-200 { border-color: #bbf7d0; }
.border-purple-100 { border-color: #faf5ff; }
.border-purple-200 { border-color: #e9d5ff; }